<template>
	<lightning-card title="JSON Test Data Editor" icon-name="custom:custom63">
		<div class="slds-p-around_medium">
			<!-- Header -->
			<div class="slds-text-align_center slds-m-bottom_large">
				<h1 class="slds-text-heading_large slds-m-bottom_small">JSON Test Data Editor</h1>
				<p class="slds-text-body_regular slds-text-color_weak">
					Upload and edit your test data JSON files, then export to CSV or download edited JSON
				</p>
			</div>

			<!-- Error Messages -->
			<template lwc:if={hasErrors}>
				<div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error slds-m-bottom_medium">
					<span class="slds-assistive-text">Error</span>
					<ul class="slds-list_dotted">
						<template for:each={validationErrors} for:item="error">
							<li key={error} class="slds-item">{error}</li>
						</template>
					</ul>
				</div>
			</template>

			<!-- File Upload Section -->
			<div class="slds-card slds-m-bottom_medium">
				<div class="slds-card__header">
					<h2 class="slds-card__header-title">
						<span class="slds-text-heading_small">Upload JSON File</span>
					</h2>
				</div>
				<div class="slds-card__body slds-card__body_inner">
					<div class="slds-form-element">
						<label class="slds-form-element__label" for="file-input">
							<abbr class="slds-required" title="required">*</abbr>JSON File
						</label>
						<div class="slds-form-element__control">
							<input type="file" id="file-input" class="slds-input" accept=".json" onchange={handleFileUpload} disabled={isLoading} />
						</div>
					</div>

					<!-- File Info -->
					<template lwc:if={hasFile}>
						<div class="slds-m-top_small">
							<div class="slds-box slds-theme_shade">
								<div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
									<div>
										<span class="slds-icon_container slds-icon-utility-file">
											<lightning-icon icon-name="utility:file" size="x-small"></lightning-icon>
										</span>
										<span class="slds-m-left_x-small">{originalFileName}</span>
									</div>
									<lightning-button
										label="Clear"
										variant="destructive"
										size="small"
										onclick={handleFileCleared}
										disabled={isLoading}
									>
									</lightning-button>
								</div>
							</div>
						</div>
					</template>
				</div>
			</div>

			<!-- Editor Section (shown when file is loaded) -->
			<template lwc:if={showEditor}>
				<div class="slds-card slds-m-bottom_medium">
					<div class="slds-card__header">
						<h2 class="slds-card__header-title">
							<span class="slds-text-heading_small">Edit Data</span>
						</h2>
					</div>
					<div class="slds-card__body slds-card__body_inner">
						<!-- Tabs -->
						<div class="slds-tabs_default">
							<ul class="slds-tabs_default__nav" role="tablist">
								<li class="slds-tabs_default__item" role="presentation">
									<a
										class="slds-tabs_default__link"
										href="#"
										role="tab"
										tabindex={dataTabIndex}
										aria-selected={dataTabSelected}
										aria-controls="data-tab"
										onclick={handleTabClick}
										data-tab="data"
									>
										Data
									</a>
								</li>
								<li class="slds-tabs_default__item" role="presentation">
									<a
										class="slds-tabs_default__link"
										href="#"
										role="tab"
										tabindex={contextTabIndex}
										aria-selected={contextTabSelected}
										aria-controls="context-tab"
										onclick={handleTabClick}
										data-tab="context"
									>
										Context Variables
									</a>
								</li>
								<li class="slds-tabs_default__item" role="presentation">
									<a
										class="slds-tabs_default__link"
										href="#"
										role="tab"
										tabindex={testsTabIndex}
										aria-selected={testsTabSelected}
										aria-controls="tests-tab"
										onclick={handleTabClick}
										data-tab="tests"
									>
										Tests
									</a>
								</li>
							</ul>

							<!-- Tab Content -->
							<div class="slds-tabs_default__content">
								<!-- Data Tab -->
								<div lwc:if={showDataTab} id="data-tab" class="slds-tabs_default__panel" role="tabpanel" aria-labelledby="data-tab">
									<div class="slds-section slds-is-open">
										<div class="slds-section__title">
											<h3 class="slds-section__title-text">Data Section</h3>
											<lightning-button
												label="Add Item"
												variant="brand"
												size="small"
												onclick={addDataItem}
												disabled={isLoading}
											>
											</lightning-button>
										</div>
										<div class="slds-section__content">
											<template lwc:if={hasDataItems}>
												<div class="slds-scrollable_x">
													<table class="slds-table slds-table_cell-buffer slds-table_bordered">
														<thead>
															<tr class="slds-line-height_reset">
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Key">Key</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Display Key">Display Key</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Value">Value</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Actions">Actions</div>
																</th>
															</tr>
														</thead>
														<tbody>
															<template for:each={dataItems} for:item="item" for:index="index">
																<tr key={item.key} class="slds-hint-parent">
																	<td data-label="Key">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={item.key}
																				onchange={updateDataItem}
																				data-index={index}
																				data-field="key"
																				disabled={isLoading}
																				placeholder="Enter key"
																			/>
																		</div>
																	</td>
																	<td data-label="Display Key">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={item.value.key}
																				onchange={updateDataItem}
																				data-index={index}
																				data-field="displayKey"
																				disabled={isLoading}
																				placeholder="Enter display key"
																			/>
																		</div>
																	</td>
																	<td data-label="Value">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={item.value.value}
																				onchange={updateDataItem}
																				data-index={index}
																				data-field="value"
																				disabled={isLoading}
																				placeholder="Enter value"
																			/>
																		</div>
																	</td>
																	<td data-label="Actions">
																		<div class="slds-truncate">
																			<lightning-button
																				label="Delete"
																				variant="destructive"
																				size="small"
																				onclick={deleteDataItem}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																</tr>
															</template>
														</tbody>
													</table>
												</div>
											</template>
											<template lwc:else>
												<div class="slds-text-align_center slds-p-around_large">
													<p class="slds-text-color_weak">No data items found. Click "Add Item" to create one.</p>
												</div>
											</template>
										</div>
									</div>
								</div>

								<!-- Context Variables Tab -->
								<div
									lwc:if={showContextTab}
									id="context-tab"
									class="slds-tabs_default__panel"
									role="tabpanel"
									aria-labelledby="context-tab"
								>
									<div class="slds-section slds-is-open">
										<div class="slds-section__title">
											<h3 class="slds-section__title-text">Context Variables</h3>
											<lightning-button
												label="Add Variable"
												variant="brand"
												size="small"
												onclick={addContextItem}
												disabled={isLoading}
											>
											</lightning-button>
										</div>
										<div class="slds-section__content">
											<template lwc:if={hasContextItems}>
												<div class="slds-scrollable_x">
													<table class="slds-table slds-table_cell-buffer slds-table_bordered">
														<thead>
															<tr class="slds-line-height_reset">
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Variable Name">Variable Name</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Description">Description</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Actions">Actions</div>
																</th>
															</tr>
														</thead>
														<tbody>
															<template for:each={contextItems} for:item="item" for:index="index">
																<tr key={item.key} class="slds-hint-parent">
																	<td data-label="Variable Name">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={item.key}
																				onchange={updateContextItem}
																				data-index={index}
																				data-field="key"
																				disabled={isLoading}
																				placeholder="Enter variable name"
																			/>
																		</div>
																	</td>
																	<td data-label="Description">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={item.value}
																				onchange={updateContextItem}
																				data-index={index}
																				data-field="value"
																				disabled={isLoading}
																				placeholder="Enter description"
																			/>
																		</div>
																	</td>
																	<td data-label="Actions">
																		<div class="slds-truncate">
																			<lightning-button
																				label="Delete"
																				variant="destructive"
																				size="small"
																				onclick={deleteContextItem}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																</tr>
															</template>
														</tbody>
													</table>
												</div>
											</template>
											<template lwc:else>
												<div class="slds-text-align_center slds-p-around_large">
													<p class="slds-text-color_weak">
														No context variables found. Click "Add Variable" to create one.
													</p>
												</div>
											</template>
										</div>
									</div>
								</div>

								<!-- Tests Tab -->
								<div
									lwc:if={showTestsTab}
									id="tests-tab"
									class="slds-tabs_default__panel"
									role="tabpanel"
									aria-labelledby="tests-tab"
								>
									<div class="slds-section slds-is-open">
										<div class="slds-section__title">
											<h3 class="slds-section__title-text">Tests</h3>
											<lightning-button label="Add Test" variant="brand" size="small" onclick={addTest} disabled={isLoading}>
											</lightning-button>
										</div>
										<div class="slds-section__content">
											<template lwc:if={hasTests}>
												<div class="slds-scrollable_x">
													<table class="slds-table slds-table_cell-buffer slds-table_bordered">
														<thead>
															<tr class="slds-line-height_reset">
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Test #">Test #</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Conversation History">Conversation History</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Utterance">Utterance</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Expected Topic">Expected Topic</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Expected Response">Expected Response</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Actions">Actions</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Context Vars">Context Vars</div>
																</th>
																<th class="slds-text-title_caps" scope="col">
																	<div class="slds-truncate" title="Manage">Manage</div>
																</th>
															</tr>
														</thead>
														<tbody>
															<template for:each={testItems} for:item="test" for:index="index">
																<tr key={test.testNumber} class="slds-hint-parent">
																	<td data-label="Test #">
																		<div class="slds-truncate">
																			<input
																				type="number"
																				class="slds-input slds-input_bare"
																				value={test.testNumber}
																				onchange={updateTest}
																				data-index={index}
																				data-field="testNumber"
																				disabled={isLoading}
																				placeholder="Test #"
																			/>
																		</div>
																	</td>
																	<td data-label="Conversation History">
																		<div class="slds-truncate">
																			<template lwc:if={test.hasConversationHistory}>
																				<div class="slds-text-body_small">
																					<template
																						for:each={test.conversationHistory}
																						for:item="conversation"
																						for:conv-index="convIndex"
																					>
																						<div key={convIndex} class="slds-m-bottom_x-small">
																							<div
																								class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
																							>
																								<div class="slds-grow">
																									<div
																										class="slds-grid slds-grid_vertical slds-gutters_xx-small"
																									>
																										<div class="slds-col">
																											<select
																												class="slds-select slds-select_small"
																												value={conversation.role}
																												onchange={updateConversation}
																												data-test-index={index}
																												data-conv-index={convIndex}
																												data-field="role"
																												disabled={isLoading}
																											>
																												<option value="user">User</option>
																												<option value="agent">Agent</option>
																											</select>
																										</div>
																										<div class="slds-col">
																											<input
																												type="text"
																												class="slds-input slds-input_small"
																												value={conversation.message}
																												onchange={updateConversation}
																												data-test-index={index}
																												data-conv-index={convIndex}
																												data-field="message"
																												disabled={isLoading}
																												placeholder="Message"
																											/>
																										</div>
																									</div>
																								</div>
																								<lightning-button-icon
																									icon-name="utility:delete"
																									variant="bare"
																									size="x-small"
																									onclick={deleteConversation}
																									data-test-index={index}
																									data-conv-index={convIndex}
																									disabled={isLoading}
																									title="Delete conversation"
																								>
																								</lightning-button-icon>
																							</div>
																						</div>
																					</template>
																				</div>
																			</template>
																			<template lwc:else>
																				<span class="slds-text-color_weak slds-text-body_small"
																					>No conversation</span
																				>
																			</template>
																			<lightning-button
																				label="Add"
																				variant="brand"
																				size="x-small"
																				onclick={addConversation}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																	<td data-label="Utterance">
																		<div class="slds-truncate">
																			<textarea
																				class="slds-textarea slds-textarea_bare"
																				value={test.utterance}
																				onchange={updateTest}
																				data-index={index}
																				data-field="utterance"
																				disabled={isLoading}
																				placeholder="Enter utterance"
																				rows="2"
																			></textarea>
																		</div>
																	</td>
																	<td data-label="Expected Topic">
																		<div class="slds-truncate">
																			<input
																				type="text"
																				class="slds-input slds-input_bare"
																				value={test.expectedTopic}
																				onchange={updateTest}
																				data-index={index}
																				data-field="expectedTopic"
																				disabled={isLoading}
																				placeholder="Expected topic"
																			/>
																		</div>
																	</td>
																	<td data-label="Expected Response">
																		<div class="slds-truncate">
																			<textarea
																				class="slds-textarea slds-textarea_bare"
																				value={test.expectedResponse}
																				onchange={updateTest}
																				data-index={index}
																				data-field="expectedResponse"
																				disabled={isLoading}
																				placeholder="Expected response"
																				rows="2"
																			></textarea>
																		</div>
																	</td>
																	<td data-label="Actions">
																		<div class="slds-truncate">
																			<template lwc:if={test.hasActions}>
																				<div class="slds-text-body_small">
																					<template
																						for:each={test.expectedActions}
																						for:item="action"
																						for:action-index="actionIndex"
																					>
																						<div key={actionIndex} class="slds-m-bottom_x-small">
																							<div
																								class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
																							>
																								<span class="slds-truncate slds-text-body_small"
																									>{action}</span
																								>
																								<lightning-button-icon
																									icon-name="utility:delete"
																									variant="bare"
																									size="x-small"
																									onclick={deleteAction}
																									data-test-index={index}
																									data-action-index={actionIndex}
																									disabled={isLoading}
																									title="Delete action"
																								>
																								</lightning-button-icon>
																							</div>
																						</div>
																					</template>
																				</div>
																			</template>
																			<template lwc:else>
																				<span class="slds-text-color_weak slds-text-body_small"
																					>No actions</span
																				>
																			</template>
																			<lightning-button
																				label="Add"
																				variant="brand"
																				size="x-small"
																				onclick={addAction}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																	<td data-label="Context Vars">
																		<div class="slds-truncate">
																			<template lwc:if={test.hasContextVars}>
																				<div class="slds-text-body_small">
																					<template
																						for:each={test.contextVariableEntries}
																						for:item="contextVar"
																						for:context-index="contextIndex"
																					>
																						<div key={contextVar.key} class="slds-m-bottom_x-small">
																							<div
																								class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
																							>
																								<div class="slds-grow">
																									<div
																										class="slds-text-body_small slds-text-color_weak"
																									>
																										{contextVar.key}:
																									</div>
																									<input
																										type="text"
																										class="slds-input slds-input_bare slds-input_small"
																										value={contextVar.value}
																										onchange={updateTestContextVar}
																										data-test-index={index}
																										data-context-key={contextVar.key}
																										disabled={isLoading}
																										placeholder="Value"
																									/>
																								</div>
																								<lightning-button-icon
																									icon-name="utility:delete"
																									variant="bare"
																									size="x-small"
																									onclick={deleteTestContextVar}
																									data-test-index={index}
																									data-context-key={contextVar.key}
																									disabled={isLoading}
																									title="Delete context variable"
																								>
																								</lightning-button-icon>
																							</div>
																						</div>
																					</template>
																				</div>
																			</template>
																			<template lwc:else>
																				<span class="slds-text-color_weak slds-text-body_small"
																					>No context vars</span
																				>
																			</template>
																			<lightning-button
																				label="Add"
																				variant="brand"
																				size="x-small"
																				onclick={addTestContextVar}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																	<td data-label="Manage">
																		<div class="slds-truncate">
																			<lightning-button
																				label="Delete"
																				variant="destructive"
																				size="small"
																				onclick={deleteTest}
																				data-index={index}
																				disabled={isLoading}
																			>
																			</lightning-button>
																		</div>
																	</td>
																</tr>
															</template>
														</tbody>
													</table>
												</div>
											</template>
											<template lwc:else>
												<div class="slds-text-align_center slds-p-around_large">
													<p class="slds-text-color_weak">No tests found. Click "Add Test" to create one.</p>
												</div>
											</template>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Export Section -->
				<div class="slds-card slds-m-bottom_medium">
					<div class="slds-card__header">
						<h2 class="slds-card__header-title">
							<span class="slds-text-heading_small">Export Options</span>
						</h2>
					</div>
					<div class="slds-card__body slds-card__body_inner">
						<div class="slds-grid slds-grid_align-center slds-gutters">
							<div class="slds-col slds-size_1-of-2">
								<lightning-button
									label="Export CSV"
									variant="brand"
									icon-name="utility:download"
									onclick={exportCsv}
									disabled={isLoading}
								>
								</lightning-button>
							</div>
							<div class="slds-col slds-size_1-of-2">
								<lightning-button
									label="Export JSON"
									variant="brand"
									icon-name="utility:download"
									onclick={exportJson}
									disabled={isLoading}
								>
								</lightning-button>
							</div>
						</div>
					</div>
				</div>

				<!-- CSV Preview Section -->
				<div class="slds-card">
					<div class="slds-card__header">
						<h2 class="slds-card__header-title">
							<span class="slds-text-heading_small">CSV Preview</span>
						</h2>
					</div>
					<div class="slds-card__body slds-card__body_inner">
						<div class="slds-box slds-theme_shade">
							<pre class="slds-text-body_small">{csvPreviewText}</pre>
						</div>
					</div>
				</div>
			</template>
		</div>
	</lightning-card>
</template>
